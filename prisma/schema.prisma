generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED") // For migrations (direct connection)
}

// ==================== AUTH & USERS ====================
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  phone         String?   @unique
  password      String
  name          String?
  isVerified    Boolean   @default(false)
  emailVerified Boolean   @default(false)
  phoneVerified Boolean   @default(false)
  role          UserRole  @default(USER)
  status        UserStatus @default(ACTIVE)
  
  // Subscription & Credits
  subscription  SubscriptionTier @default(FREE)
  subscriptionExpiry DateTime?
  
  // Relationships
  profiles      Profile[]
  redeemWallet  RedeemWallet?
  fundingWallet FundingWallet?
  transactions  Transaction[]
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  deletedAt     DateTime?

  @@map("users") // PostgreSQL table naming convention
}

// ==================== PROFILES (MATRIMONIAL) ====================
model Profile {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Profile Ownership
  profileFor    ProfileFor
  
  // Basic Info (Required)
  firstName     String
  lastName      String?
  gender        Gender
  dateOfBirth   DateTime
  
  // Additional Info (Added progressively)
  bio           String?   @db.Text // PostgreSQL Text type for longer content
  education     String?
  profession    String?
  city          String?
  country       String?
  height        String?
  maritalStatus MaritalStatus?
  religion      String    @default("Islam")
  sect          String?
  caste         String?
  motherTongue  String?
  
  // Preferences
  minAge        Int?
  maxAge        Int?
  preferredCities String? @db.Text
  
  // Privacy & Visibility
  isActive      Boolean   @default(true)
  isPublished   Boolean   @default(false)
  visibility    ProfileVisibility @default(VISIBLE)
  
  // Verification
  isVerified    Boolean   @default(false)
  verificationLevel Int   @default(0)
  
  // Stats
  profileViews  Int       @default(0)
  lastActiveAt  DateTime  @default(now())
  
  // Relationships
  photos        Photo[]
  sentConnections     Connection[] @relation("SentConnections")
  receivedConnections Connection[] @relation("ReceivedConnections")
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([userId]) // Index for faster queries
  @@index([gender, isPublished, isActive]) // Composite index for search
  @@map("profiles")
}

// ==================== PHOTOS ====================
model Photo {
  id          String    @id @default(cuid())
  profileId   String
  profile     Profile   @relation(fields: [profileId], references: [id], onDelete: Cascade)
  url         String
  isMain      Boolean   @default(false)
  isPublic    Boolean   @default(true)
  isVerified  Boolean   @default(false)
  order       Int       @default(0)
  createdAt   DateTime  @default(now())

  @@index([profileId])
  @@map("photos")
}

// ==================== CONNECTIONS ====================
model Connection {
  id          String    @id @default(cuid())
  
  senderId    String
  sender      Profile   @relation("SentConnections", fields: [senderId], references: [id], onDelete: Cascade)
  
  receiverId  String
  receiver    Profile   @relation("ReceivedConnections", fields: [receiverId], references: [id], onDelete: Cascade)
  
  status      ConnectionStatus @default(PENDING)
  message     String?   @db.Text
  
  // Track credit usage
  creditsUsed Int       @default(1)
  
  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  respondedAt DateTime?
  
  @@unique([senderId, receiverId])
  @@index([senderId])
  @@index([receiverId])
  @@index([status])
  @@map("connections")
}

// ==================== WALLETS ====================
model RedeemWallet {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance       Int       @default(0)
  frozenBalance Int       @default(0)
  limit         Int
  lastRedeemed  DateTime  @default(now())
  nextRedemption DateTime
  creditsWasted Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("redeem_wallets")
}

model FundingWallet {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance       Int       @default(0)
  frozenBalance Int       @default(0)
  totalPurchased Int      @default(0)
  totalSpent    Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("funding_wallets")
}

// ==================== TRANSACTIONS ====================
model Transaction {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type          TransactionType
  walletType    WalletType
  amount        Int
  description   String

  // For purchases
  paymentMethod String?
  paymentId     String?
  
  createdAt     DateTime  @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("transactions")
}

// ==================== ENUMS ====================
enum UserRole {
  USER
  SUPPORT_AGENT
  CONTENT_EDITOR
  CONSULTANT
  SUPERVISOR
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
}

enum SubscriptionTier {
  FREE
  STANDARD
  SILVER
  GOLD
  PLATINUM
  PRO
}

enum ProfileFor {
  SELF
  SON
  DAUGHTER
  BROTHER
  SISTER
  RELATIVE
  CLIENT
}

enum Gender {
  MALE
  FEMALE
}

enum MaritalStatus {
  NEVER_MARRIED
  DIVORCED
  WIDOWED
  SEPARATED
}

enum ProfileVisibility {
  VISIBLE
  HIDDEN
  PRIVATE
}

enum ConnectionStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
  BLOCKED
}

enum TransactionType {
  CREDIT
  DEBIT
  PURCHASE
  REDEMPTION
  REFUND
  BONUS
}

enum WalletType {
  REDEEM
  FUNDING
}
