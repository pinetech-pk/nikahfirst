generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

// ============================================================================
// SECTION 1: AUTH & USERS
// ============================================================================

model User {
  id                  String            @id @default(cuid())
  email               String            @unique
  phone               String?           @unique
  phoneChangedAt      DateTime?         // Track when phone was last changed (30-day cooldown)
  password            String
  name                String?           // Contact person name
  isVerified          Boolean           @default(false)
  emailVerified       Boolean           @default(false)
  phoneVerified       Boolean           @default(false)
  role                UserRole          @default(USER)
  status              UserStatus        @default(ACTIVE)

  // Subscription Plan (NEW - dynamic plans)
  subscriptionPlanId  String?
  subscriptionPlan    SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id])
  subscriptionExpiry  DateTime?
  subscribedAt        DateTime?         // When user subscribed to current plan

  // SNAPSHOT VALUES - copied at registration/upgrade (don't change when plan is modified)
  tierFreeCredits     Int               @default(3)
  tierWalletLimit     Int               @default(5)
  tierRedeemCredits   Int               @default(1)
  tierRedeemCycleDays Int               @default(15)
  tierProfileLimit    Int               @default(1)
  tierPriceMonthly    Decimal           @default(0)   @db.Decimal(10, 2)
  tierPriceYearly     Decimal           @default(0)   @db.Decimal(10, 2)

  // DEPRECATED - kept for backward compatibility
  subscription        SubscriptionTier  @default(FREE)  // @deprecated use subscriptionPlanId
  profileLimit        Int               @default(1)     // @deprecated use tierProfileLimit

  // Relationships
  profiles            Profile[]
  redeemWallet        RedeemWallet?
  fundingWallet       FundingWallet?
  transactions        Transaction[]
  fieldSuggestions    FieldSuggestion[] @relation("UserSuggestions")
  reviewedSuggestions FieldSuggestion[] @relation("ReviewedSuggestions")
  topUpRequests       TopUpRequest[]    @relation("UserTopUpRequests")
  processedTopUps     TopUpRequest[]    @relation("ProcessedTopUpRequests")
  phoneVerifications  PhoneVerification[]
  notificationsRead   AdminNotification[] @relation("NotificationReader")

  // Timestamps
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  lastLoginAt         DateTime?
  deletedAt           DateTime?

  @@index([subscriptionPlanId])
  @@map("users")
}

// ============================================================================
// SECTION 1B: SUBSCRIPTION PLANS (Global Settings)
// ============================================================================

model SubscriptionPlan {
  id                  String            @id @default(cuid())

  // Plan Identity
  slug                String            @unique  // FREE, STANDARD, SILVER, etc.
  name                String            // Display name
  description         String?           @db.Text

  // Credits Configuration
  freeCredits         Int               @default(0)   // Credits given on signup/renewal
  walletLimit         Int               @default(5)   // Max wallet balance
  redeemCredits       Int               @default(1)   // Credits per redemption cycle
  redeemCycleDays     Int               @default(15)  // Days between redemptions

  // Profile Limits
  profileLimit        Int               @default(1)   // Max active profiles

  // Pricing (USD)
  priceMonthly        Decimal           @default(0)   @db.Decimal(10, 2)
  priceYearly         Decimal           @default(0)   @db.Decimal(10, 2)
  yearlyDiscountPct   Int               @default(0)   // e.g., 13 for 13%

  // Display & Status
  sortOrder           Int               @default(0)
  isActive            Boolean           @default(true)
  isDefault           Boolean           @default(false) // Default for new users (FREE)
  color               String?           // Badge color for UI

  // Features (for marketing display)
  features            Json?             // ["Feature 1", "Feature 2", ...]

  // Timestamps
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // Relations
  users               User[]

  @@map("subscription_plans")
}

// ============================================================================
// SECTION 1C: CREDIT ACTIONS (Global Settings - Credit Usage Costs)
// ============================================================================

model CreditAction {
  id                  String            @id @default(cuid())

  // Action Identity
  slug                String            @unique  // REQUEST_CONNECTION, ACCESS_PHOTOS, etc.
  name                String            // Display name
  description         String?           @db.Text
  category            String?           // "connection", "access", "boost", etc.

  // Cost Configuration
  creditCost          Int               @default(1)   // Credits required
  durationDays        Int?              // For time-based actions (boost = 7 or 15 days)

  // Status & Display
  isActive            Boolean           @default(true)
  sortOrder           Int               @default(0)

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@map("credit_actions")
}

// ============================================================================
// SECTION 1C-B: REDEEM ACTIONS (Global Settings - Credit Rewards)
// ============================================================================

model RedeemAction {
  id                  String            @id @default(cuid())

  // Action Identity
  slug                String            @unique  // PROFILE_CREATION, REFERRAL_SUCCESS, SOCIAL_SHARE, etc.
  name                String            // Display name
  description         String?           @db.Text
  category            String?           // "onboarding", "engagement", "referral", "promotion"

  // Reward Configuration
  creditsAwarded      Int               @default(1)   // Credits given for this action
  maxRedemptions      Int?              // Max times user can earn from this action (null = unlimited)
  cooldownDays        Int?              // Days before user can earn again (null = no cooldown)

  // Status & Display
  isActive            Boolean           @default(true)
  sortOrder           Int               @default(0)

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@map("redeem_actions")
}

// ============================================================================
// SECTION 1D: CREDIT PACKAGES (Global Settings - TopUp Plans)
// ============================================================================

model CreditPackage {
  id                  String            @id @default(cuid())

  // Package Identity
  slug                String            @unique  // PACK_5, PACK_7, etc.
  name                String            // Display name

  // Credits & Pricing (USD)
  credits             Int               // Number of credits
  price               Decimal           @db.Decimal(10, 2)  // Price in USD

  // Bonus/Savings Display
  bonusCredits        Int               @default(0)   // Extra credits included
  savingsPercent      Int?              // Display "Save X%"

  // Display & Status
  isPopular           Boolean           @default(false)  // Highlight this package
  isActive            Boolean           @default(true)
  sortOrder           Int               @default(0)

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // Relations
  topUpRequests       TopUpRequest[]

  @@map("credit_packages")
}

// ============================================================================
// SECTION 1E: TOP-UP REQUESTS (Manual Payment System)
// ============================================================================

model TopUpRequest {
  id                  String            @id @default(cuid())
  requestNumber       String            @unique  // TXN-2024-0001 format

  // User relationship
  userId              String
  user                User              @relation("UserTopUpRequests", fields: [userId], references: [id], onDelete: Cascade)

  // Package selected
  packageId           String
  package             CreditPackage     @relation(fields: [packageId], references: [id])

  // Request details
  credits             Int               // Credits to be added
  bonusCredits        Int               @default(0)
  amount              Decimal           @db.Decimal(10, 2)  // Amount in USD

  // Payment info
  paymentMethod       PaymentMethod     @default(BANK_TRANSFER)

  // Status
  status              TopUpStatus       @default(PENDING)

  // Processing
  processedBy         String?
  processor           User?             @relation("ProcessedTopUpRequests", fields: [processedBy], references: [id])
  processedAt         DateTime?
  adminNotes          String?           @db.Text
  rejectionReason     String?

  // Timestamps
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("top_up_requests")
}

// ============================================================================
// SECTION 1F: PAYMENT SETTINGS (Admin Configurable)
// ============================================================================

model PaymentSetting {
  id                  String            @id @default(cuid())
  method              PaymentMethod     @unique
  isActive            Boolean           @default(true)

  // Display info
  label               String            // "Bank Transfer", "JazzCash"
  instructions        String            @db.Text  // Payment instructions shown to user

  // Account details
  accountTitle        String?
  accountNumber       String?
  bankName            String?
  branchCode          String?
  iban                String?
  mobileNumber        String?           // For JazzCash/EasyPaisa

  sortOrder           Int               @default(0)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@map("payment_settings")
}

// ============================================================================
// SECTION 2: PROFILES (MATRIMONIAL)
// ============================================================================

model Profile {
  id                  String            @id @default(cuid())
  userId              String
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // ==================== BASIC INFO ====================
  profileFor          ProfileFor
  gender              Gender
  dateOfBirth         DateTime
  maritalStatus       MaritalStatus
  numberOfChildren    Int               @default(0)
  childrenLivingWith  String?           @db.VarChar(50) // Max 50 chars
  
  // ==================== ORIGIN & ETHNICITY ====================
  originId            String?
  origin              Origin?           @relation(fields: [originId], references: [id])
  
  ethnicityId         String?
  ethnicity           Ethnicity?        @relation(fields: [ethnicityId], references: [id])
  
  casteId             String?
  caste               Caste?            @relation(fields: [casteId], references: [id])
  
  // Custom values (pending admin approval)
  customCaste         String?           @db.VarChar(50)
  
  // ==================== RESIDENTIAL STATUS ====================
  countryOfOriginId   String?
  countryOfOrigin     Country?          @relation("CountryOfOrigin", fields: [countryOfOriginId], references: [id])
  
  countryLivingInId   String?
  countryLivingIn     Country?          @relation("CountryLivingIn", fields: [countryLivingInId], references: [id])
  
  stateProvinceId     String?
  stateProvince       StateProvince?    @relation(fields: [stateProvinceId], references: [id])
  
  cityId              String?
  city                City?             @relation(fields: [cityId], references: [id])
  
  visaStatus          VisaStatus?       // Only if origin != living country

  // User-suggested location if not found in list (pending admin approval)
  suggestedLocation   String?           @db.VarChar(200)

  // ==================== RELIGIOUS SECT ====================
  sectId              String?
  sect                Sect?             @relation(fields: [sectId], references: [id])
  
  maslakId            String?
  maslak              Maslak?           @relation(fields: [maslakId], references: [id])
  
  // ==================== FAMILY STATUS ====================
  religiousBelonging  ReligiousBelonging?
  socialStatus        SocialStatus?
  numberOfBrothers    Int               @default(0)
  numberOfSisters     Int               @default(0)
  marriedBrothers     Int               @default(0)
  marriedSisters      Int               @default(0)
  fatherOccupation    String?           @db.VarChar(50) // Optional, max 50 chars
  propertyOwnership   String?           @db.VarChar(50) // Optional, max 50 chars
  
  // ==================== PHYSICAL ATTRIBUTES ====================
  heightId            String?
  height              Height?           @relation(fields: [heightId], references: [id])
  
  complexion          Complexion?
  hasDisability       Boolean           @default(false)
  disabilityDetails   String?           @db.VarChar(100)
  
  // ==================== QUALIFICATIONS ====================
  educationLevelId    String?
  educationLevel      EducationLevel?   @relation(fields: [educationLevelId], references: [id])
  
  educationFieldId    String?
  educationField      EducationField?   @relation(fields: [educationFieldId], references: [id])
  
  educationDetails    String?           @db.VarChar(100) // Optional details
  
  // ==================== CAREER ====================
  occupationType      OccupationType?
  occupationDetails   String?           @db.VarChar(100) // Area of expertise
  
  incomeRangeId       String?
  incomeRange         IncomeRange?      @relation(fields: [incomeRangeId], references: [id])
  
  // ==================== LANGUAGE ====================
  motherTongueId      String?
  motherTongue        Language?         @relation(fields: [motherTongueId], references: [id])
  otherMotherTongue   String?           // For "Other" option - stores user's custom entry
  
  // ==================== PROFILE CONTENT ====================
  bio                 String?           @db.Text // About me
  
  // ==================== PRIVACY & VISIBILITY ====================
  isActive            Boolean           @default(true)  // User-controlled on/off
  originAudience      OriginAudience    @default(SAME_ORIGIN) // Who can view based on origin
  showIncome          Boolean           @default(false) // Show income to connections only

  // DEPRECATED - kept for backward compatibility
  isPublished         Boolean           @default(false)  // @deprecated Use moderationStatus
  visibility          ProfileVisibility @default(VISIBLE) // @deprecated

  // ==================== MODERATION ====================
  moderationStatus    ModerationStatus  @default(PENDING)
  moderatedAt         DateTime?
  moderatedBy         String?           // Admin/moderator user ID
  rejectionReason     String?           @db.Text

  // ==================== BAN TRACKING ====================
  bannedAt            DateTime?
  bannedBy            String?           // Admin user ID
  banReason           String?           @db.Text

  // ==================== VERIFICATION ====================
  // Note: Detailed verification is in ProfileVerification table
  isVerified          Boolean           @default(false)  // Quick check flag
  verification        ProfileVerification?
  
  // ==================== ANALYTICS ====================
  profileViews        Int               @default(0)
  uniqueVisitors      Int               @default(0)
  interestsReceived   Int               @default(0)
  interestsSent       Int               @default(0)
  profileCompletion   Int               @default(0) // Percentage 0-100
  lastActiveAt        DateTime          @default(now())
  
  // ==================== RELATIONSHIPS ====================
  photos              Photo[]
  sentConnections     Connection[]      @relation("SentConnections")
  receivedConnections Connection[]      @relation("ReceivedConnections")
  profileVisitors     ProfileVisitor[]
  
  // ==================== TIMESTAMPS ====================
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@index([userId])
  @@index([gender, isPublished, isActive])
  @@index([originId])
  @@index([ethnicityId])
  @@index([countryLivingInId])
  @@index([educationLevelId])
  @@index([createdAt])
  @@map("profiles")
}

// ============================================================================
// SECTION 2B: PROFILE VERIFICATION
// ============================================================================

model ProfileVerification {
  id                  String            @id @default(cuid())
  profileId           String            @unique
  profile             Profile           @relation(fields: [profileId], references: [id], onDelete: Cascade)

  // Overall Status (manually set by admin)
  isVerified          Boolean           @default(false)
  verificationLevel   Int               @default(0)  // 0 = not verified, 1-9 levels

  // Individual Verification Fields
  ageVerified                 Boolean   @default(false)
  ageVerifiedAt               DateTime?
  ageVerifiedBy               String?
  ageVerificationNote         String?   @db.Text

  educationVerified           Boolean   @default(false)
  educationVerifiedAt         DateTime?
  educationVerifiedBy         String?
  educationVerificationNote   String?   @db.Text

  residencyVerified           Boolean   @default(false)
  residencyVerifiedAt         DateTime?
  residencyVerifiedBy         String?
  residencyVerificationNote   String?   @db.Text

  propertyVerified            Boolean   @default(false)
  propertyVerifiedAt          DateTime?
  propertyVerifiedBy          String?
  propertyVerificationNote    String?   @db.Text

  employmentVerified          Boolean   @default(false)
  employmentVerifiedAt        DateTime?
  employmentVerifiedBy        String?
  employmentVerificationNote  String?   @db.Text

  identityVerified            Boolean   @default(false)  // Government ID
  identityVerifiedAt          DateTime?
  identityVerifiedBy          String?
  identityVerificationNote    String?   @db.Text

  // Audit Trail
  overallNotes        String?           @db.Text  // General verification notes
  lastVerifiedAt      DateTime?
  lastVerifiedBy      String?

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@map("profile_verifications")
}

// ============================================================================
// SECTION 3: PHOTOS
// ============================================================================

model Photo {
  id                  String            @id @default(cuid())
  profileId           String
  profile             Profile           @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  // Cloudinary URLs
  publicId            String            // Cloudinary public_id
  originalUrl         String            // Authenticated URL for connections
  blurredUrl          String            // Blurred URL for public view
  thumbnailUrl        String?           // Small thumbnail
  
  // Metadata
  isPrimary           Boolean           @default(false)
  isPrivate           Boolean           @default(false)  // true = visible only to connections
  sortOrder           Int               @default(0)
  status              PhotoStatus       @default(PENDING)
  
  // Moderation
  moderatedAt         DateTime?
  moderatedBy         String?
  rejectionReason     String?
  
  // Timestamps
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@index([profileId])
  @@index([status])
  @@map("photos")
}

// ============================================================================
// SECTION 4: PROFILE VISITORS (Analytics)
// ============================================================================

model ProfileVisitor {
  id                  String            @id @default(cuid())
  profileId           String
  profile             Profile           @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  visitorProfileId    String            // Who viewed
  visitorUserId       String            // User who viewed
  
  isRevealed          Boolean           @default(false) // Did owner pay to reveal?
  revealedAt          DateTime?
  creditsUsed         Int               @default(0)
  
  viewedAt            DateTime          @default(now())

  @@unique([profileId, visitorProfileId])
  @@index([profileId])
  @@index([visitorProfileId])
  @@index([viewedAt])
  @@map("profile_visitors")
}

// ============================================================================
// SECTION 5: CONNECTIONS
// ============================================================================

model Connection {
  id                  String            @id @default(cuid())
  
  senderId            String
  sender              Profile           @relation("SentConnections", fields: [senderId], references: [id], onDelete: Cascade)
  
  receiverId          String
  receiver            Profile           @relation("ReceivedConnections", fields: [receiverId], references: [id], onDelete: Cascade)
  
  status              ConnectionStatus  @default(PENDING)
  message             String?           @db.Text
  
  creditsUsed         Int               @default(1)
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  respondedAt         DateTime?
  expiresAt           DateTime?         // Connection request expiry
  
  @@unique([senderId, receiverId])
  @@index([senderId])
  @@index([receiverId])
  @@index([status])
  @@map("connections")
}

// ============================================================================
// SECTION 6: LOOKUP TABLES - ORIGIN & ETHNICITY
// ============================================================================

model Origin {
  id                  String            @id @default(cuid())
  slug                String            @unique
  label               String
  labelNative         String?
  emoji               String?
  description         String?
  sortOrder           Int               @default(0)
  isActive            Boolean           @default(true)

  // Flexible terminology for sub-categories (region-aware)
  // Level 1: Ethnicity (Pakistani), Tribe (Arab), Ethnic Group (African)
  level1Label         String            @default("Ethnicity")
  level1LabelPlural   String            @default("Ethnicities")
  // Level 2: Caste (Pakistani), Sub-tribe (Arab), Clan (African)
  level2Label         String            @default("Caste")
  level2LabelPlural   String            @default("Castes")
  level2Enabled       Boolean           @default(true) // Some origins may not need level 2

  // Relations
  ethnicities         Ethnicity[]
  profiles            Profile[]

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@map("origins")
}

model Ethnicity {
  id                  String            @id @default(cuid())
  originId            String
  origin              Origin            @relation(fields: [originId], references: [id], onDelete: Cascade)
  
  slug                String
  label               String
  labelNative         String?
  sortOrder           Int               @default(0)
  isPopular           Boolean           @default(false)
  isActive            Boolean           @default(true)
  
  // Relations
  castes              Caste[]
  languages           EthnicityLanguage[]
  profiles            Profile[]
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@unique([originId, slug])
  @@index([originId])
  @@map("ethnicities")
}

model Caste {
  id                  String            @id @default(cuid())
  ethnicityId         String
  ethnicity           Ethnicity         @relation(fields: [ethnicityId], references: [id], onDelete: Cascade)
  
  slug                String
  label               String
  labelNative         String?
  sortOrder           Int               @default(0)
  isPopular           Boolean           @default(false)
  isActive            Boolean           @default(true)
  usageCount          Int               @default(0) // Track popularity
  
  // Relations
  profiles            Profile[]
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@unique([ethnicityId, slug])
  @@index([ethnicityId])
  @@map("castes")
}

// ============================================================================
// SECTION 7: LOOKUP TABLES - LOCATION
// ============================================================================

model Country {
  id                  String            @id @default(cuid())
  code                String            @unique // ISO 3166-1 alpha-2 (PK, IN, US)
  name                String
  nameNative          String?
  phoneCode           String?           // +92, +1, etc.
  currency            String?           // PKR, INR, USD
  currencySymbol      String?           // ₨, $, £, etc.
  sortOrder           Int               @default(0)
  isActive            Boolean           @default(true)

  // Relations
  statesProvinces     StateProvince[]
  profilesOrigin      Profile[]         @relation("CountryOfOrigin")
  profilesLiving      Profile[]         @relation("CountryLivingIn")
  incomeRanges        IncomeRange[]
  languages           CountryLanguage[] // Languages spoken in this country

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@map("countries")
}

model StateProvince {
  id                  String            @id @default(cuid())
  countryId           String
  country             Country           @relation(fields: [countryId], references: [id], onDelete: Cascade)
  
  code                String?
  name                String
  nameNative          String?
  sortOrder           Int               @default(0)
  isActive            Boolean           @default(true)
  
  // Relations
  cities              City[]
  profiles            Profile[]
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@unique([countryId, name])
  @@index([countryId])
  @@map("states_provinces")
}

model City {
  id                  String            @id @default(cuid())
  stateProvinceId     String
  stateProvince       StateProvince     @relation(fields: [stateProvinceId], references: [id], onDelete: Cascade)
  
  name                String
  nameNative          String?
  sortOrder           Int               @default(0)
  isPopular           Boolean           @default(false) // Major cities
  isActive            Boolean           @default(true)
  
  // Relations
  profiles            Profile[]
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@unique([stateProvinceId, name])
  @@index([stateProvinceId])
  @@map("cities")
}

// ============================================================================
// SECTION 8: LOOKUP TABLES - RELIGIOUS SECT
// ============================================================================

model Sect {
  id                  String            @id @default(cuid())
  slug                String            @unique
  label               String
  sortOrder           Int               @default(0)
  isActive            Boolean           @default(true)
  
  // Relations
  maslaks             Maslak[]
  profiles            Profile[]
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@map("sects")
}

model Maslak {
  id                  String            @id @default(cuid())
  sectId              String
  sect                Sect              @relation(fields: [sectId], references: [id], onDelete: Cascade)
  
  slug                String
  label               String
  description         String?
  sortOrder           Int               @default(0)
  isActive            Boolean           @default(true)
  
  // Relations
  profiles            Profile[]
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@unique([sectId, slug])
  @@index([sectId])
  @@map("maslaks")
}

// ============================================================================
// SECTION 9: LOOKUP TABLES - EDUCATION
// ============================================================================

model EducationLevel {
  id                  String            @id @default(cuid())
  slug                String            @unique
  label               String
  level               Int               // 1-9 for filtering (higher = more education)
  yearsOfEducation    Int               // 10, 12, 14, 16, 18, etc.
  sortOrder           Int               @default(0)
  isActive            Boolean           @default(true)
  
  // Auto-tags for search
  tags                String[]          @default([])
  
  // Relations
  profiles            Profile[]
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@map("education_levels")
}

model EducationField {
  id                  String            @id @default(cuid())
  slug                String            @unique
  label               String
  category            String?           // "Islamic", "Social Science", "Natural Science", "Applied Science"
  sortOrder           Int               @default(0)
  isActive            Boolean           @default(true)
  
  // Auto-tags for search
  tags                String[]          @default([])
  
  // Relations
  profiles            Profile[]
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@map("education_fields")
}

// ============================================================================
// SECTION 10: LOOKUP TABLES - INCOME
// ============================================================================

model IncomeRange {
  id                  String            @id @default(cuid())
  countryId           String?           // Null = global, otherwise country-specific
  country             Country?          @relation(fields: [countryId], references: [id], onDelete: Cascade)

  slug                String
  label               String            // "75,000 - 125,000 PKR"
  currency            String            // PKR, USD, GBP, CAD, etc.
  period              IncomePeriod      // MONTHLY, ANNUAL
  minValue            Int?              // For filtering/sorting
  maxValue            Int?
  sortOrder           Int               @default(0)
  isActive            Boolean           @default(true)

  // Relations
  profiles            Profile[]

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@unique([countryId, slug])
  @@index([countryId])
  @@map("income_ranges")
}

// ============================================================================
// SECTION 11: LOOKUP TABLES - PHYSICAL
// ============================================================================

model Height {
  id                  String            @id @default(cuid())
  slug                String            @unique
  labelImperial       String            // 5'6"
  labelMetric         String            // 168 cm
  centimeters         Int               // For filtering
  sortOrder           Int               @default(0)
  isActive            Boolean           @default(true)
  
  // Relations
  profiles            Profile[]
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@map("heights")
}

// ============================================================================
// SECTION 12: LOOKUP TABLES - LANGUAGE
// ============================================================================

model Language {
  id                  String            @id @default(cuid())
  code                String            @unique // ISO 639-1
  slug                String            @unique
  label               String
  labelNative         String?
  sortOrder           Int               @default(0)
  isActive            Boolean           @default(true)
  isGlobal            Boolean           @default(false) // If true, shown for all countries

  // Relations
  ethnicities         EthnicityLanguage[]
  profiles            Profile[]
  countries           CountryLanguage[] // Countries where this language is spoken

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@map("languages")
}

// Junction table for Country <-> Language (for country-scoped mother tongues)
model CountryLanguage {
  id                  String            @id @default(cuid())
  countryId           String
  country             Country           @relation(fields: [countryId], references: [id], onDelete: Cascade)
  languageId          String
  language            Language          @relation(fields: [languageId], references: [id], onDelete: Cascade)

  sortOrder           Int               @default(0) // Order within country
  isPrimary           Boolean           @default(false) // Is this a primary/national language

  @@unique([countryId, languageId])
  @@map("country_languages")
}

// Junction table for Ethnicity <-> Language
model EthnicityLanguage {
  id                  String            @id @default(cuid())
  ethnicityId         String
  ethnicity           Ethnicity         @relation(fields: [ethnicityId], references: [id], onDelete: Cascade)
  languageId          String
  language            Language          @relation(fields: [languageId], references: [id], onDelete: Cascade)
  
  isPrimary           Boolean           @default(false)
  
  @@unique([ethnicityId, languageId])
  @@map("ethnicity_languages")
}

// ============================================================================
// SECTION 13: USER SUGGESTIONS SYSTEM
// ============================================================================

model FieldSuggestion {
  id                  String            @id @default(cuid())
  
  // What type of suggestion
  fieldType           SuggestionFieldType
  
  // Context (which origin/ethnicity it belongs to)
  originId            String?
  ethnicityId         String?
  
  // The suggestion
  suggestedValue      String
  suggestedLabel      String?
  additionalInfo      String?           @db.Text
  
  // Who suggested
  userId              String
  user                User              @relation("UserSuggestions", fields: [userId], references: [id])
  
  // Review status
  status              SuggestionStatus  @default(PENDING)
  reviewedById        String?
  reviewedBy          User?             @relation("ReviewedSuggestions", fields: [reviewedById], references: [id])
  reviewNote          String?
  reviewedAt          DateTime?
  
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@index([status])
  @@index([fieldType])
  @@map("field_suggestions")
}

// ============================================================================
// SECTION 14: WALLETS & TRANSACTIONS
// ============================================================================

model RedeemWallet {
  id                  String            @id @default(cuid())
  userId              String            @unique
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance             Int               @default(0)
  frozenBalance       Int               @default(0)
  limit               Int               // Wallet limit (snapshot from tier)
  redeemCredits       Int               @default(1)   // Credits per redemption (snapshot)
  redeemCycleDays     Int               @default(15)  // Days between redemptions (snapshot)
  lastRedeemed        DateTime          @default(now())
  nextRedemption      DateTime
  creditsWasted       Int               @default(0)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@map("redeem_wallets")
}

model FundingWallet {
  id                  String            @id @default(cuid())
  userId              String            @unique
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance             Int               @default(0)
  frozenBalance       Int               @default(0)
  totalPurchased      Int               @default(0)
  totalSpent          Int               @default(0)
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@map("funding_wallets")
}

model Transaction {
  id                  String            @id @default(cuid())
  userId              String
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type                TransactionType
  walletType          WalletType
  amount              Int
  description         String
  
  // For purchases
  paymentMethod       String?
  paymentId           String?
  
  // Reference
  referenceType       String?           // "connection", "reveal_visitor", etc.
  referenceId         String?           // ID of related entity
  
  createdAt           DateTime          @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("transactions")
}

// ============================================================================
// SECTION 14B: EMAIL VERIFICATION (OTP)
// ============================================================================

model EmailVerification {
  id          String   @id @default(cuid())
  email       String
  otp         String   // 6-digit OTP code
  type        VerificationType @default(REGISTRATION)
  expiresAt   DateTime
  verified    Boolean  @default(false)
  attempts    Int      @default(0) // Track failed attempts
  createdAt   DateTime @default(now())

  @@index([email])
  @@index([email, otp])
  @@index([expiresAt])
  @@map("email_verifications")
}

enum VerificationType {
  REGISTRATION     // New user registration
  PASSWORD_RESET   // Password reset request
  EMAIL_CHANGE     // Email change verification
  PHONE_VERIFICATION // Phone number verification
}

// ============================================================================
// SECTION 14C: PHONE VERIFICATION (MANUAL OTP)
// ============================================================================

model PhoneVerification {
  id          String   @id @default(cuid())
  userId      String
  phone       String   // Phone number being verified
  otp         String   // 6-digit OTP code
  expiresAt   DateTime // Long expiry (24 hours for manual verification)
  verified    Boolean  @default(false)
  attempts    Int      @default(0)

  // Admin tracking
  requestedAt DateTime @default(now())
  verifiedAt  DateTime?
  verifiedBy  String?  // Admin who verified (if manual)

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([phone])
  @@index([phone, otp])
  @@index([expiresAt])
  @@map("phone_verifications")
}

// ============================================================================
// SECTION 14D: ADMIN NOTIFICATIONS
// ============================================================================

model AdminNotification {
  id          String    @id @default(cuid())
  type        AdminNotificationType
  title       String
  message     String    @db.Text
  data        Json?     // Extra data: { userId, userName, oldPhone, newPhone, etc. }
  priority    NotificationPriority @default(NORMAL)

  // Read status
  isRead      Boolean   @default(false)
  readById    String?   // Admin who marked it read
  readBy      User?     @relation("NotificationReader", fields: [readById], references: [id], onDelete: SetNull)
  readAt      DateTime?

  // Target roles (empty array = all admins)
  targetRoles UserRole[] @default([])

  // Action link
  actionUrl   String?   // Link to relevant page in admin panel

  createdAt   DateTime  @default(now())

  @@index([type])
  @@index([isRead])
  @@index([createdAt])
  @@map("admin_notifications")
}

enum AdminNotificationType {
  PHONE_UPDATE           // User updated phone number
  PHONE_VERIFY_REQUEST   // User requested phone verification
  PROFILE_PENDING        // New profile awaiting approval
  NEW_USER               // New user registered
  SUPPORT_TICKET         // New support request
  TOP_UP_REQUEST         // New top-up request
  PROFILE_REPORTED       // Profile reported by user
  SYSTEM_ALERT           // System alert
}

enum NotificationPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// ============================================================================
// SECTION 15: ENUMS
// ============================================================================

enum UserRole {
  USER
  SUPPORT_AGENT
  CONTENT_EDITOR
  CONSULTANT
  SUPERVISOR
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
}

enum SubscriptionTier {
  FREE
  STANDARD
  SILVER
  GOLD
  PLATINUM
  PRO
}

enum ProfileFor {
  SELF
  SON
  DAUGHTER
  BROTHER
  SISTER
  RELATIVE
  FRIEND
  CLIENT
  OTHER
}

enum Gender {
  MALE    // Groom
  FEMALE  // Bride
}

enum MaritalStatus {
  NEVER_MARRIED
  DIVORCED
  WIDOWED
  MARRIED  // Only for Groom (polygamy)
}

enum VisaStatus {
  CITIZEN
  PERMANENT_RESIDENT
  WORK_VISA
  STUDENT_VISA
  VISIT_VISA
  REFUGEE
  OTHER
}

enum ReligiousBelonging {
  STRICT
  INCLINED
  MODERATE
  LIBERAL
}

enum SocialStatus {
  ELITE_CLASS
  ESTABLISHED_MIDDLE
  TECHNICALLY_MIDDLE
  AFFLUENT_WORKING
  TRADITIONAL_WORKING
}

enum Complexion {
  VERY_FAIR
  MEDIUM_FAIR
  TAN_WHEATISH    // Sanwla
  DARK
}

enum OccupationType {
  SELF_EMPLOYED
  PRIVATE_JOB
  GOVERNMENT_JOB
  ARMED_FORCES
  NOT_WORKING
  STUDENT
  RETIRED
}

enum IncomePeriod {
  MONTHLY
  ANNUAL
}

enum PhotoStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ModerationStatus {
  PENDING      // Newly created, awaiting review
  APPROVED     // Moderator approved
  REJECTED     // Moderator rejected (can resubmit after edit)
  BANNED       // Admin banned (cannot resubmit without appeal)
}

enum ProfileVisibility {
  VISIBLE
  HIDDEN
  PRIVATE
}

enum OriginAudience {
  SAME_ORIGIN      // Profile visible only to users with matching origin
  ALL_ORIGINS      // Profile visible globally to all origins
}

enum ConnectionStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
  BLOCKED
  WITHDRAWN
}

enum SuggestionFieldType {
  CASTE
  ETHNICITY
  CITY
  EDUCATION_FIELD
  MOTHER_TONGUE
  OTHER
}

enum SuggestionStatus {
  PENDING
  APPROVED
  REJECTED
  DUPLICATE
  MERGED
}

enum TransactionType {
  CREDIT
  DEBIT
  PURCHASE
  REDEMPTION
  REFUND
  BONUS
  TOP_UP
}

enum WalletType {
  REDEEM
  FUNDING
}

enum TopUpStatus {
  PENDING           // Awaiting payment verification
  COMPLETED         // Approved, credits added
  REJECTED          // Rejected by admin
  CANCELLED         // Cancelled by user
}

enum PaymentMethod {
  BANK_TRANSFER
  JAZZCASH
  EASYPAISA
  STRIPE            // Future
  OTHER
}
